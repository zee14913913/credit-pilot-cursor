# CreditPilot Railway 完整运行指南

**包含所有设置和运行时注意事项**

---

## 📋 第一部分：部署前检查清单

### 代码层面检查 ✅

#### 1. 必需文件
- [ ] `Dockerfile` 存在于根目录
- [ ] `backend/start.sh` 存在且可执行
- [ ] `backend/main.py` 存在
- [ ] `backend/models.py` 存在
- [ ] `backend/init_db.py` 存在
- [ ] `backend/reminder_system.py` 存在
- [ ] `backend/email_service.py` 存在
- [ ] `backend/requirements.txt` 存在

#### 2. 代码配置检查
- [ ] 路径使用 `/app/uploads` 和 `/app/reports`（不是相对路径）
- [ ] 端口使用环境变量 `PORT`（不是硬编码）
- [ ] 数据库使用 `DATABASE_URL`（不是 `DB_URL`）
- [ ] 监听地址是 `0.0.0.0`（不是 `127.0.0.1`）

---

## 📋 第二部分：Railway 配置检查清单

### Postgres 服务

#### 必需配置
- [ ] 服务已创建
- [ ] Variables 中 `DATABASE_URL` 存在（自动生成，不要修改）
- [ ] Settings → Start Command = **留空**
- [ ] Settings → Cron Schedule = **留空**

#### ⚠️ 注意事项
- **不要**在 Postgres 服务上配置 Volume
- **不要**在 Postgres 服务上配置自定义 Start Command
- **不要**修改 Postgres 服务自动生成的变量

---

### Web 服务

#### Build 设置
- [ ] Builder = `Dockerfile`
- [ ] Dockerfile Path = `Dockerfile`（或 `/Dockerfile`）
- [ ] Metal Build Environment = 可以开启 ✅

#### Deploy 设置
- [ ] Custom Start Command = **留空** ⚠️ **关键**
- [ ] Cron Schedule = **留空**（如果使用方案B）

#### Networking 设置
- [ ] Port = `8000` ⚠️ **必须**

#### Variables 设置（最关键）

**必需变量列表**：

| 变量名 | 值 | 格式要求 | 检查 |
|--------|-----|----------|------|
| `DATABASE_URL` | `${{ Postgres.DATABASE_URL }}` | 双大括号，有空格 | [ ] ⚠️ **最重要** |
| `SENDER_EMAIL` | `business@infinite-gz.com` | 字符串 | [ ] |
| `SENDER_PASSWORD` | `grqcgnrwqhbeocox` | 字符串 | [ ] |
| `RECIPIENT_EMAIL` | `wang041396@gmail.com` | 字符串 | [ ] |
| `SMTP_SERVER` | `smtp.gmail.com` | 字符串 | [ ] |
| `SMTP_PORT` | `587` | 数字 | [ ] |
| `UPLOAD_DIR` | `/app/uploads` | 绝对路径 | [ ] |
| `REPORTS_DIR` | `/app/reports` | 绝对路径 | [ ] |

**⚠️ DATABASE_URL 格式检查**：
- ✅ 正确：`${{ Postgres.DATABASE_URL }}`
- ❌ 错误：`${Postgres.DATABASE_URL}`（单大括号）
- ❌ 错误：`${{Postgres.DATABASE_URL}}`（没有空格）
- ❌ 错误：手动写死的连接字符串

**如何设置 DATABASE_URL**：
1. 进入 Web 服务 → Variables
2. 点击 "New Variable" 或查找现有 `DATABASE_URL`
3. Name：`DATABASE_URL`
4. Value：`${{ Postgres.DATABASE_URL }}`
   - Railway UI 会自动显示下拉提示
   - 选择 Postgres 服务
5. 点击 "Add" 或 "Save"

#### Volume 挂载
- [ ] `uploads` Volume 已挂载，Mount Path = `/app/uploads`
- [ ] `reports` Volume 已挂载，Mount Path = `/app/reports`

**如何挂载 Volume**：
1. 进入 Web 服务 → Settings → Volumes
2. 点击 "Attach Volume"
3. 选择 `uploads` Volume
4. 确认 Mount Path = `/app/uploads`
5. 点击 "Attach"
6. 重复步骤挂载 `reports` Volume

---

### Reminder-Cron 服务（方案B）

#### Build 设置
- [ ] Builder = `Dockerfile`
- [ ] Dockerfile Path = `Dockerfile`

#### Deploy 设置（关键）
- [ ] Custom Start Command = `cd backend && python3 reminder_system.py` ⚠️ **必须**
- [ ] Cron Schedule = `0 14 * * *` ⚠️ **必须**

**⚠️ Cron 配置注意事项**：
- Cron 是在服务的 Settings → Deploy → Cron Schedule 中设置
- **不是**项目级别的 "Cron Job"（这是旧做法）
- 命令由服务的 Start Command 控制

#### Variables 设置
- [ ] 所有变量与 Web 服务相同（8个变量）
- [ ] `DATABASE_URL` = `${{ Postgres.DATABASE_URL }}` ⚠️ **关键**

#### Volume 挂载（如果需要）
- [ ] `reports` Volume 已挂载，Mount Path = `/app/reports`

---

### Volume（项目级别）

#### 创建 Volume
- [ ] 在项目主页（不是服务页面）创建
- [ ] 点击 "+Create" → "VOLUME"
- [ ] 创建 `uploads` Volume，Mount Path = `/app/uploads`
- [ ] 创建 `reports` Volume，Mount Path = `/app/reports`

#### ⚠️ 注意事项
- Volume 必须在**项目级别**创建
- 然后 Attach 到需要的服务
- Mount Path 必须与代码中的路径一致

---

## 📋 第三部分：运行时注意事项

### 1. 数据库连接

#### 注意事项
- **DATABASE_URL 格式**：必须是 `${{ Postgres.DATABASE_URL }}`
- **服务名称**：确保 `Postgres` 是你的实际数据库服务名称
- **连接池**：代码已配置连接池，自动处理连接问题
- **连接超时**：如果连接失败，检查 Postgres 服务是否运行

#### 常见问题
- **连接失败**：检查 DATABASE_URL 格式和服务名称
- **超时**：检查 Postgres 服务状态
- **权限错误**：检查 Postgres 服务是否正常运行

---

### 2. 端口配置

#### 注意事项
- **端口号**：必须是 `8000`
- **监听地址**：必须是 `0.0.0.0`（不是 `127.0.0.1`）
- **环境变量**：代码使用 `os.getenv("PORT", 8000)`

#### 常见问题
- **端口被占用**：检查是否有其他服务使用 8000 端口
- **无法访问**：检查 Networking 设置中的端口配置

---

### 3. 文件路径

#### 注意事项
- **上传目录**：`/app/uploads`（绝对路径）
- **报告目录**：`/app/reports`（绝对路径）
- **Volume 挂载**：必须与代码中的路径一致

#### 常见问题
- **路径不存在**：检查 Volume 是否已挂载
- **权限错误**：检查 Volume 挂载是否正确
- **文件丢失**：检查 Volume 是否持久化

---

### 4. 环境变量

#### 注意事项
- **所有变量必须设置**：8个必需变量
- **格式正确**：特别是 `DATABASE_URL`
- **敏感信息**：不要泄露密码和密钥

#### 常见问题
- **变量未设置**：检查所有变量是否已添加
- **格式错误**：检查 `DATABASE_URL` 格式
- **值错误**：检查变量值是否正确

---

### 5. Cron 任务

#### 注意事项
- **执行时间**：UTC 14:00（马来西亚时间 22:00）
- **执行命令**：`cd backend && python3 reminder_system.py`
- **日志查看**：在 Reminder-Cron 服务 → Logs 中查看

#### 常见问题
- **不执行**：检查 Cron Schedule 格式和 Start Command
- **执行失败**：查看日志中的错误信息
- **邮件未发送**：检查邮件相关环境变量

---

## 📋 第四部分：故障排查步骤

### 步骤 1：检查部署日志

1. 进入 Web 服务 → Deployments → 最新部署 → Logs
2. 查找关键信息：
   - ✅ "✅ DATABASE_URL 已设置"
   - ✅ "✅ 数据库表创建成功"
   - ✅ "启动API服务器..."
   - ❌ 任何错误信息（红色）

### 步骤 2：检查服务状态

1. 检查所有服务是否运行：
   - Postgres 服务：绿色 ✅
   - Web 服务：绿色 ✅
   - Reminder-Cron 服务：绿色 ✅

2. 如果服务未运行：
   - 查看错误日志
   - 检查配置是否正确

### 步骤 3：测试数据库连接

在 Web 服务 Shell 中执行：
```bash
cd backend && python3 init_db.py
```

**预期结果**：
- ✅ 无错误
- ✅ 显示 "✅ 数据库初始化完成"

**如果失败**：
- 检查 `DATABASE_URL` 格式
- 检查 Postgres 服务是否运行
- 查看错误信息

### 步骤 4：测试 Web 服务

```bash
curl https://your-app.railway.app/health
```

**预期结果**：
- ✅ 返回 `{"status": "healthy"}`

**如果失败**：
- 检查端口配置
- 检查部署日志
- 检查服务状态

### 步骤 5：检查环境变量

在 Web 服务 Shell 中执行：
```bash
echo $DATABASE_URL
echo $PORT
echo $UPLOAD_DIR
echo $REPORTS_DIR
```

**预期结果**：
- ✅ 所有变量都有值
- ✅ `DATABASE_URL` 格式正确

---

## 📋 第五部分：成功运行后的操作

### 1. 验证系统运行

#### 检查清单
- [ ] Web 服务健康检查通过
- [ ] 数据库连接正常
- [ ] API 端点可访问
- [ ] Volume 挂载正常

#### 测试步骤
1. 访问健康检查：`https://your-app.railway.app/health`
2. 访问 API 文档：`https://your-app.railway.app/docs`
3. 测试数据库连接：在 Shell 中执行 `cd backend && python3 init_db.py`

---

### 2. 导入初始数据（如果需要）

#### CSV 导入
1. 准备 CSV 文件（参考 `CSV导入说明.md`）
2. 通过 API 端点导入：
   ```
   POST https://your-app.railway.app/api/import/csv
   ```
3. 上传 CSV 文件

#### 手动添加数据
1. 通过 API 端点添加数据
2. 或使用数据库管理工具

---

### 3. 配置邮件通知

#### 检查邮件配置
- [ ] `SENDER_EMAIL` 已设置
- [ ] `SENDER_PASSWORD` 已设置（Gmail 应用密码）
- [ ] `RECIPIENT_EMAIL` 已设置
- [ ] `SMTP_SERVER` 和 `SMTP_PORT` 已设置

#### 测试邮件发送
1. 等待 Cron 任务执行（UTC 14:00）
2. 或手动触发 Reminder-Cron 服务
3. 检查收件箱

---

### 4. 监控系统运行

#### 日常监控
- [ ] 检查 Web 服务日志（是否有错误）
- [ ] 检查 Cron 服务日志（是否正常执行）
- [ ] 检查邮件是否正常发送
- [ ] 检查数据库连接是否稳定

#### 定期检查
- [ ] 每周检查一次系统运行状态
- [ ] 检查 Volume 存储空间
- [ ] 检查数据库性能
- [ ] 检查 API 响应时间

---

### 5. 维护操作

#### 代码更新
1. 修改代码
2. 推送到 GitHub
3. Railway 自动重新部署
4. 检查部署日志
5. 验证功能正常

#### 环境变量更新
1. 进入服务 → Variables
2. 修改变量值
3. 保存
4. 服务自动重启
5. 检查是否正常

#### 数据库备份
- Railway Postgres 服务自动备份
- 也可以手动导出数据

---

## 📋 第六部分：常见问题解决

### 问题 1：服务无法启动

**症状**：服务一直显示 "Deploying" 或失败

**排查步骤**：
1. 查看部署日志
2. 检查 Dockerfile 是否正确
3. 检查 `backend/start.sh` 是否可执行
4. 检查所有必需文件是否存在

**解决方案**：
- 修复代码错误
- 检查配置是否正确
- 重新部署

---

### 问题 2：数据库连接失败

**症状**：`init_db.py` 执行失败，显示连接错误

**排查步骤**：
1. 检查 `DATABASE_URL` 格式：`${{ Postgres.DATABASE_URL }}`
2. 检查 Postgres 服务是否运行
3. 检查服务名称是否正确

**解决方案**：
- 修正 `DATABASE_URL` 格式
- 确认 Postgres 服务运行
- 重新测试连接

---

### 问题 3：端口错误

**症状**：无法访问 Web 服务

**排查步骤**：
1. 检查 Networking → Port = `8000`
2. 检查代码中端口配置
3. 检查服务是否运行

**解决方案**：
- 确认端口配置一致
- 重新部署服务

---

### 问题 4：文件路径错误

**症状**：上传文件失败或报告生成失败

**排查步骤**：
1. 检查 Volume 是否挂载
2. 检查 Mount Path 是否正确
3. 检查代码中的路径

**解决方案**：
- 确认 Volume 已挂载
- 确认路径一致
- 重新挂载 Volume

---

### 问题 5：Cron 不执行

**症状**：定时任务不运行，邮件未发送

**排查步骤**：
1. 检查 Cron Schedule 格式：`0 14 * * *`
2. 检查 Start Command：`cd backend && python3 reminder_system.py`
3. 检查所有环境变量是否设置
4. 查看 Cron 服务日志

**解决方案**：
- 修正 Cron Schedule 格式
- 确认 Start Command 正确
- 设置所有必需变量
- 查看日志中的错误信息

---

### 问题 6：邮件发送失败

**症状**：Cron 执行但邮件未发送

**排查步骤**：
1. 检查所有邮件相关环境变量
2. 检查 Gmail 应用密码是否有效
3. 查看日志中的错误信息

**解决方案**：
- 确认所有邮件变量正确
- 重新生成 Gmail 应用密码
- 检查 SMTP 配置

---

## 📋 第七部分：重要提醒

### ⚠️ 安全注意事项

1. **不要泄露敏感信息**：
   - 不要在代码中硬编码密码
   - 不要在日志中输出敏感信息
   - 使用环境变量存储敏感数据

2. **定期更新**：
   - 定期更新依赖包
   - 定期检查安全漏洞
   - 定期备份数据

3. **访问控制**：
   - 限制 API 访问（如果需要）
   - 使用 HTTPS（Railway 自动提供）
   - 考虑添加身份验证

---

### ⚠️ 性能注意事项

1. **数据库连接**：
   - 使用连接池（已配置）
   - 避免长时间占用连接
   - 定期检查连接数

2. **文件存储**：
   - 定期清理旧文件
   - 监控 Volume 存储空间
   - 考虑文件大小限制

3. **API 性能**：
   - 监控响应时间
   - 优化数据库查询
   - 考虑添加缓存

---

### ⚠️ 维护注意事项

1. **日志监控**：
   - 定期查看服务日志
   - 关注错误信息
   - 记录重要事件

2. **备份策略**：
   - Railway Postgres 自动备份
   - 定期导出重要数据
   - 保存配置文件

3. **更新策略**：
   - 测试环境验证
   - 生产环境谨慎更新
   - 保留回滚方案

---

## ✅ 完成检查清单

### 部署前
- [ ] 所有代码文件存在且正确
- [ ] Railway 配置完成
- [ ] 所有环境变量已设置
- [ ] Volume 已创建并挂载

### 部署后
- [ ] 服务成功启动
- [ ] 数据库连接正常
- [ ] Web 服务可访问
- [ ] API 端点正常

### 运行时
- [ ] 系统正常运行
- [ ] Cron 任务正常执行
- [ ] 邮件正常发送
- [ ] 文件上传/下载正常

---

**指南完成时间**：2025-12-10  
**适用版本**：Railway 最新 UI 和官方文档
