# CreditPilot Railway 部署故障排查指南

---

## 🔍 快速诊断

### 步骤 1：检查部署日志

在 Railway Web 服务 → Deployments → 最新部署 → Logs

**查找关键信息**：
- ✅ "✅ DATABASE_URL 已设置"
- ✅ "✅ 数据库表创建成功"
- ✅ "启动API服务器..."
- ❌ 任何错误信息（红色）

---

### 步骤 2：常见错误及解决方案

#### 错误 1：数据库连接失败

**症状**：
```
✗ 数据库初始化失败: could not connect to server
或
✗ 数据库初始化失败: connection refused
```

**原因**：
- DATABASE_URL 格式错误
- Postgres 服务未运行
- 服务名称不匹配

**解决**：
1. 检查 Web 服务 Variables → `DATABASE_URL`
2. 确认格式：`${{ Postgres.DATABASE_URL }}`（双大括号）
3. 确认 Postgres 服务名称正确（区分大小写）
4. 确认 Postgres 服务正在运行

---

#### 错误 2：端口错误

**症状**：
```
Address already in use
或
Port 8000 is not available
```

**原因**：
- 端口配置不一致
- 端口被占用

**解决**：
1. 检查 Web 服务 Networking → Port = `8000`
2. 确认代码中使用 `os.getenv("PORT", 8000)`
3. 确认启动脚本使用 `${PORT:-8000}`

---

#### 错误 3：路径错误

**症状**：
```
No such file or directory: /app/uploads
或
Permission denied: /app/reports
```

**原因**：
- Volume 未挂载
- Mount Path 不一致

**解决**：
1. 检查 Volume 是否已创建（项目级别）
2. 检查 Volume 是否已附加到服务
3. 确认 Mount Path：`/app/uploads`, `/app/reports`
4. 确认代码中使用相同路径

---

#### 错误 4：模块导入错误

**症状**：
```
ModuleNotFoundError: No module named 'xxx'
或
ImportError: cannot import name 'xxx'
```

**原因**：
- 依赖未安装
- Python 路径问题

**解决**：
1. 检查 `backend/requirements.txt` 是否包含所有依赖
2. 检查 Dockerfile 是否正确安装依赖
3. 确认工作目录：`WORKDIR /app/backend`

---

#### 错误 5：Cron 服务不执行

**症状**：
- Cron 任务不运行
- 邮件未发送

**原因**：
- Cron Schedule 格式错误
- Start Command 错误
- 环境变量未设置

**解决**：
1. 检查 Reminder-Cron 服务 Deploy → Cron Schedule = `0 14 * * *`
2. 检查 Start Command = `cd backend && python3 reminder_system.py`
3. 检查所有环境变量已设置（与 Web 服务相同）

---

## 🧪 诊断命令

### 在 Railway Shell 中执行

#### 1. 检查环境变量
```bash
echo $DATABASE_URL
echo $PORT
echo $UPLOAD_DIR
echo $REPORTS_DIR
```

#### 2. 测试数据库连接
```bash
cd backend
python3 init_db.py
```

#### 3. 检查文件路径
```bash
ls -la /app/uploads
ls -la /app/reports
```

#### 4. 检查 Python 模块
```bash
cd backend
python3 -c "from models import Base, engine; print('✅ 模块导入成功')"
```

---

## 📋 完整检查清单

### 代码层面
- [ ] 所有文件已推送 to GitHub
- [ ] Dockerfile 正确
- [ ] `backend/start.sh` 可执行
- [ ] `backend/requirements.txt` 完整

### Railway 配置层面
- [ ] Postgres 服务正在运行
- [ ] Web 服务 DATABASE_URL = `${{ Postgres.DATABASE_URL }}`
- [ ] Web 服务 Port = `8000`
- [ ] Volume 已创建并挂载
- [ ] 所有环境变量已设置

### 部署后
- [ ] 部署日志无错误
- [ ] 数据库初始化成功
- [ ] Web 服务健康检查通过
- [ ] API 端点可访问

---

## 🚀 如果问题仍然存在

### 1. 收集信息
- 部署日志（完整）
- 错误信息（精确）
- Railway 配置截图（遮住敏感信息）

### 2. 检查点
- DATABASE_URL 格式
- 服务名称
- 端口配置
- Volume 挂载
- 环境变量

### 3. 重新部署
- 推送最新代码
- 在 Railway 中手动触发重新部署
- 查看新的部署日志

---

## ✅ 成功标志

如果看到以下信息，说明部署成功：

```
============================================================
CreditPilot 启动中...
============================================================
✅ DATABASE_URL 已设置
============================================================
初始化数据库...
============================================================
📊 数据库连接: postgresql://***@...
🔨 创建数据库表...
✅ 数据库表创建成功
✅ 数据库初始化完成
============================================================
启动API服务器...
============================================================
INFO:     Started server process
INFO:     Uvicorn running on http://0.0.0.0:8000
```

---

**故障排查完成时间**：2025-12-10
