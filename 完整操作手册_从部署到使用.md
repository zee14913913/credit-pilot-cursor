# CreditPilot 完整操作手册

**从部署到日常使用的完整指南**  
**项目**：CreditPilot 信用卡账单管理系统  
**部署平台**：Railway

---

## 📋 目录

1. [部署前准备](#部署前准备)
2. [Railway 配置步骤](#railway-配置步骤)
3. [部署后验证](#部署后验证)
4. [成功运行后的操作](#成功运行后的操作)
5. [日常使用指南](#日常使用指南)
6. [运行时注意事项](#运行时注意事项)
7. [维护和监控](#维护和监控)
8. [故障处理](#故障处理)

---

## 🚀 部署前准备

### 1.1 代码检查清单

**必需文件**：
- [ ] `Dockerfile` 存在于根目录
- [ ] `backend/start.sh` 存在且可执行
- [ ] `backend/main.py` 存在
- [ ] `backend/models.py` 存在
- [ ] `backend/init_db.py` 存在
- [ ] `backend/reminder_system.py` 存在
- [ ] `backend/email_service.py` 存在
- [ ] `backend/requirements.txt` 存在

**代码配置检查**：
- [ ] 路径使用 `/app/uploads` 和 `/app/reports`（不是相对路径）
- [ ] 端口使用环境变量 `PORT`（不是硬编码）
- [ ] 数据库使用 `DATABASE_URL` 环境变量

### 1.2 GitHub 仓库准备

- [ ] 代码已推送到 GitHub 仓库：`zee14913913/credit-pilot-cursor`
- [ ] 所有文件都在仓库中
- [ ] `.env` 文件**不要**推送到仓库（已在 `.gitignore` 中）

### 1.3 环境变量准备

**需要设置的变量值**：
- `SENDER_EMAIL` = `business@infinite-gz.com`
- `SENDER_PASSWORD` = `grqcgnrwqhbeocox`（Gmail 应用密码）
- `RECIPIENT_EMAIL` = `wang041396@gmail.com`
- `SMTP_SERVER` = `smtp.gmail.com`
- `SMTP_PORT` = `587`
- `UPLOAD_DIR` = `/app/uploads`
- `REPORTS_DIR` = `/app/reports`

---

## ⚙️ Railway 配置步骤

### 第一步：创建 Postgres 服务

1. **创建服务**
   - 在 Railway 项目主页，点击 **"+Create"**
   - 选择 **"DATABASE"** → **"PostgreSQL"**
   - Railway 会自动创建并配置

2. **检查 Variables**
   - 进入 Postgres 服务 → **Variables**
   - 确认 `DATABASE_URL` 存在（自动生成）
   - **⚠️ 不要修改这些变量**

3. **检查 Settings**
   - 进入 Postgres 服务 → **Settings**
   - 确认 Start Command 和 Cron Schedule 都**留空**

### 第二步：创建 Web 服务

1. **创建服务**
   - 在 Railway 项目主页，点击 **"+Create"**
   - 选择 **"GITHUB REPO"**
   - 选择仓库：`zee14913913/credit-pilot-cursor`

2. **Build 设置**
   - Settings → Build → Builder = `Dockerfile`
   - Dockerfile Path = `Dockerfile`

3. **Deploy 设置**
   - Settings → Deploy → Custom Start Command = **留空**
   - Settings → Deploy → Cron Schedule = **留空**

4. **Networking 设置**
   - Settings → Networking → Port = `8000`

5. **Variables 设置**（最关键）
   - Variables → `DATABASE_URL` = `${{ Postgres.DATABASE_URL }}` ⚠️ **双大括号格式**
   - Variables → 添加其他 7 个变量（见 1.3）

6. **Volume 挂载**
   - 先创建 Volume（项目级别）：`uploads` 和 `reports`
   - 然后 Attach 到 Web 服务

### 第三步：创建 Reminder-Cron 服务（方案B）

1. **创建服务**
   - 在 Railway 项目主页，点击 **"+Create"**
   - 选择 **"GITHUB REPO"**
   - 选择同一个仓库：`zee14913913/credit-pilot-cursor`

2. **重命名服务**
   - Settings → Service Name = `reminder-cron`

3. **Build 设置**
   - Settings → Build → Builder = `Dockerfile`

4. **Deploy 设置**（关键）
   - Settings → Deploy → Custom Start Command = `cd backend && python3 reminder_system.py`
   - Settings → Deploy → Cron Schedule = `0 14 * * *`

5. **Variables 设置**
   - Variables → 添加所有变量（与 Web 服务相同）

6. **Volume 挂载**
   - Settings → Volumes → Attach `reports` Volume

### 第四步：创建 Volume（项目级别）

1. **创建 uploads Volume**
   - 在项目主页，点击 **"+Create"** → **"VOLUME"**
   - Name: `uploads`
   - Mount Path: `/app/uploads`

2. **创建 reports Volume**
   - 在项目主页，点击 **"+Create"** → **"VOLUME"**
   - Name: `reports`
   - Mount Path: `/app/reports`

3. **附加到服务**
   - Web 服务 → Settings → Volumes → Attach `uploads` 和 `reports`
   - Reminder-Cron 服务 → Settings → Volumes → Attach `reports`

---

## ✅ 部署后验证

### 验证 1：检查部署日志

**Web 服务** → **Deployments** → 最新部署 → **Logs**

**应该看到**：
```
============================================================
CreditPilot 启动中...
============================================================
✅ DATABASE_URL 已设置
============================================================
初始化数据库...
============================================================
📊 数据库连接: postgresql://***@...
🔨 创建数据库表...
✅ 数据库表创建成功
✅ 数据库初始化完成
============================================================
启动API服务器...
============================================================
INFO:     Started server process
INFO:     Uvicorn running on http://0.0.0.0:8000
```

**如果看到错误**：
- 检查 `DATABASE_URL` 格式
- 检查所有环境变量是否设置
- 查看错误信息，参考故障处理部分

### 验证 2：测试数据库连接

1. 进入 **Web 服务** → **Shell** 或 **Terminal**
2. 执行：
   ```bash
   cd backend && python3 init_db.py
   ```
3. **预期结果**：
   - ✅ 无错误
   - ✅ 显示 "✅ 数据库初始化完成"

### 验证 3：测试 Web 服务

1. **获取公共 URL**
   - Web 服务 → **Networking** → **Public Networking**
   - 点击 **"Generate Domain"** 或查看已有域名
   - 例如：`https://creditpilot-production.up.railway.app`

2. **测试健康检查**
   ```bash
   curl https://your-app.railway.app/health
   ```
   或浏览器访问：
   ```
   https://your-app.railway.app/health
   ```
   **预期**：返回 `{"status": "healthy"}`

3. **访问 API 文档**
   ```
   https://your-app.railway.app/docs
   ```
   **预期**：显示 Swagger UI 文档页面

### 验证 4：测试 Cron 服务

1. **查看部署日志**
   - Reminder-Cron 服务 → **Deployments** → 最新部署 → **Logs**

2. **等待或手动触发**
   - 等待到 UTC 14:00（马来西亚时间 22:00）
   - 或手动触发一次部署来测试

3. **预期结果**：
   - ✅ 服务在 Cron 时间启动
   - ✅ 执行 `reminder_system.py`
   - ✅ 生成 Excel 报告
   - ✅ 发送邮件
   - ✅ 日志中无错误

---

## 🎯 成功运行后的操作

### 第一步：保存重要信息

**记录以下信息**：

1. **Web 服务公共 URL**
   ```
   https://your-app.railway.app
   ```
   - 用于访问 API
   - 用于 iPad App 连接

2. **API 文档地址**
   ```
   https://your-app.railway.app/docs
   ```
   - 用于查看所有 API 端点
   - 用于测试 API

3. **Railway 项目链接**
   - 用于管理和监控

### 第二步：配置 iPad App（如果有）

1. **设置 API 基础 URL**
   - 在 iPad App 中设置：`https://your-app.railway.app`
   - 确保使用 HTTPS

2. **测试连接**
   - 在 App 中测试连接
   - 确认可以访问 API

### 第三步：导入初始数据（可选）

**如果有 CSV 文件需要导入**：

1. **准备 CSV 文件**
   - 格式参考：`CSV导入说明.md`

2. **使用 API 导入**
   - 访问：`https://your-app.railway.app/docs`
   - 找到 `POST /api/import/csv` 端点
   - 上传 CSV 文件

3. **或使用命令行**
   ```bash
   curl -X POST "https://your-app.railway.app/api/import/csv" \
     -F "file=@your-file.csv"
   ```

### 第四步：上传账单 PDF（可选）

**如果有账单 PDF 需要解析**：

1. **使用 API 上传**
   - 访问：`https://your-app.railway.app/docs`
   - 找到 `POST /api/statements/upload` 端点
   - 上传 PDF 文件

2. **或使用命令行**
   ```bash
   curl -X POST "https://your-app.railway.app/api/statements/upload" \
     -F "file=@statement.pdf" \
     -F "client_name=客户名称"
   ```

### 第五步：验证邮件发送

1. **等待第一次 Cron 执行**
   - 等待到 UTC 14:00（马来西亚时间 22:00）
   - 或手动触发 Reminder-Cron 服务部署

2. **检查收件箱**
   - 检查 `wang041396@gmail.com` 收件箱
   - 应该收到每日提醒邮件
   - 邮件附件包含 Excel 报告

3. **如果未收到邮件**
   - 检查 Reminder-Cron 服务日志
   - 检查邮件相关环境变量
   - 参考故障处理部分

---

## 📱 日常使用指南

### 1. 上传账单 PDF

**方法 1：使用 API 文档（推荐）**
1. 访问：`https://your-app.railway.app/docs`
2. 找到 `POST /api/statements/upload`
3. 点击 "Try it out"
4. 上传 PDF 文件
5. 填写 `client_name`（客户名称）
6. 点击 "Execute"

**方法 2：使用命令行**
```bash
curl -X POST "https://your-app.railway.app/api/statements/upload" \
  -F "file=@statement.pdf" \
  -F "client_name=客户名称"
```

**方法 3：使用 iPad App**
- 在 App 中选择上传功能
- 选择 PDF 文件
- 填写客户信息
- 提交

### 2. 查看 Dashboard 数据

**访问 Dashboard API**：
```bash
curl https://your-app.railway.app/api/dashboard/stats
```

**返回数据包括**：
- 总账单数
- 已验证账单数
- 总余额
- 即将到期的账单数

### 3. 查看账单列表

**访问账单列表 API**：
```bash
curl https://your-app.railway.app/api/statements
```

### 4. 上传单据（Merchant Receipts, Payment Slips）

**使用文档上传 API**：
```bash
curl -X POST "https://your-app.railway.app/api/documents/upload" \
  -F "file=@receipt.jpg" \
  -F "statement_id=1" \
  -F "document_type=merchant_receipt"
```

**文档类型**：
- `merchant_receipt` - 商户收据
- `payment_slip` - 付款单
- `transfer_slip` - 转账单

### 5. 生成每日报告

**手动触发报告生成**：
```bash
curl https://your-app.railway.app/api/reminders/daily-report
```

**或等待自动生成**：
- 每天 UTC 14:00（马来西亚时间 22:00）自动生成
- 自动发送到 `wang041396@gmail.com`

---

## ⚠️ 运行时注意事项

### 1. 环境变量管理

**重要**：
- ✅ 所有敏感信息（密码、密钥）都通过环境变量设置
- ✅ 不要在代码中硬编码敏感信息
- ✅ `.env` 文件不要推送到 GitHub

**修改环境变量**：
1. 在 Railway 服务 → Variables 中修改
2. 修改后需要重新部署服务
3. Railway 会自动重新部署

### 2. 数据库管理

**重要**：
- ✅ 数据库由 Railway 自动管理
- ✅ 不要手动删除数据库服务
- ✅ 定期备份重要数据（Railway 会自动备份）

**查看数据库**：
- 在 Postgres 服务 → Data 中可以查看数据
- 或使用 Railway 提供的数据库管理工具

### 3. Volume 管理

**重要**：
- ✅ Volume 中的数据是持久的
- ✅ 删除服务不会删除 Volume（除非明确删除）
- ✅ Volume 有大小限制（根据 Railway 计划）

**查看 Volume 使用情况**：
- 在服务 → Settings → Volumes 中查看
- 监控 Volume 使用量

### 4. 日志管理

**查看日志**：
- 服务 → Deployments → 最新部署 → Logs
- 或服务 → Logs（实时日志）

**日志保留**：
- Railway 会保留最近一段时间的日志
- 重要日志建议导出保存

### 5. 服务监控

**监控指标**：
- 服务 → Metrics 可以查看：
  - CPU 使用率
  - 内存使用率
  - 网络流量
  - 请求数量

**设置告警**：
- 在 Railway 中可以设置告警
- 当服务异常时发送通知

### 6. 成本管理

**Railway 免费计划限制**：
- 每月 $5 免费额度
- 超出后按使用量计费

**节省成本**：
- 监控服务使用情况
- 不需要时暂停服务
- 优化资源使用

### 7. 安全注意事项

**API 安全**：
- ✅ 使用 HTTPS（Railway 自动提供）
- ⚠️ 生产环境应限制 CORS 来源（当前允许所有来源）
- ⚠️ 考虑添加 API 认证（如果需要）

**数据安全**：
- ✅ 数据库连接使用环境变量
- ✅ 敏感信息不存储在代码中
- ✅ 定期更新依赖包

### 8. 邮件发送注意事项

**Gmail 应用密码**：
- ✅ 使用 Gmail 应用密码（不是普通密码）
- ✅ 应用密码格式：`grqcgnrwqhbeocox`
- ⚠️ 如果密码失效，需要重新生成并更新

**邮件发送限制**：
- Gmail 有每日发送限制
- 如果发送失败，检查：
  - 应用密码是否正确
  - SMTP 配置是否正确
  - 是否超过发送限制

### 9. Cron 任务注意事项

**执行时间**：
- Cron Schedule: `0 14 * * *` = UTC 14:00 = 马来西亚时间 22:00
- 如果需要修改时间，修改 Cron Schedule

**执行失败处理**：
- 查看 Reminder-Cron 服务日志
- 检查环境变量是否正确
- 检查数据库连接是否正常

**手动触发**：
- 可以手动触发 Reminder-Cron 服务部署来测试
- 在服务 → Deployments → 点击 "Redeploy"

### 10. 代码更新

**更新代码流程**：
1. 在本地修改代码
2. 推送到 GitHub：
   ```bash
   git add .
   git commit -m "更新说明"
   git push origin main
   ```
3. Railway 会自动检测并重新部署

**部署注意事项**：
- 部署期间服务可能短暂不可用
- 建议在低峰期部署
- 部署前检查代码是否正确

---

## 🔧 维护和监控

### 日常维护

**每日检查**：
- [ ] 检查服务是否正常运行
- [ ] 检查 Cron 任务是否执行
- [ ] 检查邮件是否发送成功
- [ ] 查看日志是否有错误

**每周检查**：
- [ ] 检查数据库使用情况
- [ ] 检查 Volume 使用情况
- [ ] 检查服务资源使用情况
- [ ] 检查成本使用情况

**每月检查**：
- [ ] 更新依赖包（如果有安全更新）
- [ ] 备份重要数据
- [ ] 检查服务性能
- [ ] 优化配置（如果需要）

### 监控指标

**关键指标**：
- 服务运行状态
- 数据库连接状态
- API 响应时间
- 错误率
- 邮件发送成功率

**设置告警**：
- 服务宕机告警
- 错误率过高告警
- 资源使用过高告警

---

## 🚨 故障处理

### 常见问题

#### 问题 1：服务无法启动

**症状**：部署失败，服务无法启动

**检查**：
1. 查看部署日志中的错误信息
2. 检查 `DATABASE_URL` 格式
3. 检查所有环境变量是否设置
4. 检查代码是否有语法错误

**解决**：
- 修复代码错误
- 重新设置环境变量
- 重新部署

#### 问题 2：数据库连接失败

**症状**：`init_db.py` 执行失败

**检查**：
1. `DATABASE_URL` 格式：`${{ Postgres.DATABASE_URL }}`
2. Postgres 服务是否运行
3. 服务名称是否正确

**解决**：
- 重新设置 `DATABASE_URL`
- 检查 Postgres 服务状态
- 重新部署

#### 问题 3：邮件发送失败

**症状**：Cron 执行但邮件未发送

**检查**：
1. Gmail 应用密码是否正确
2. SMTP 配置是否正确
3. 收件人邮箱是否正确

**解决**：
- 更新 `SENDER_PASSWORD`
- 检查 SMTP 配置
- 查看 Reminder-Cron 服务日志

#### 问题 4：Cron 任务不执行

**症状**：定时任务不运行

**检查**：
1. Cron Schedule 格式：`0 14 * * *`
2. Start Command 是否正确
3. 环境变量是否设置

**解决**：
- 检查 Cron Schedule 格式
- 检查 Start Command
- 重新设置环境变量

#### 问题 5：文件上传失败

**症状**：无法上传文件

**检查**：
1. Volume 是否挂载
2. Mount Path 是否正确
3. 路径权限是否正确

**解决**：
- 检查 Volume 挂载
- 确认路径配置
- 重新挂载 Volume

---

## 📞 获取帮助

### 文档资源

- **Railway 官方文档**：https://docs.railway.com
- **项目文档**：查看项目中的 `.md` 文件
- **API 文档**：`https://your-app.railway.app/docs`

### 检查工具

- **部署检查清单**：`RAILWAY_配置检查清单_最终版.md`
- **故障排查指南**：`故障排查指南.md`
- **验证脚本**：`verify_creditpilot_deployment.py`

---

## ✅ 完成检查清单

### 部署完成
- [ ] 所有服务已创建并配置
- [ ] 所有环境变量已设置
- [ ] Volume 已创建并挂载
- [ ] 部署日志无错误

### 验证完成
- [ ] 数据库连接测试通过
- [ ] Web 服务健康检查通过
- [ ] API 文档可访问
- [ ] Cron 服务测试通过

### 使用准备
- [ ] 已保存公共 URL
- [ ] 已配置 iPad App（如果有）
- [ ] 已导入初始数据（如果需要）
- [ ] 已验证邮件发送

---

## 🎉 恭喜！

如果所有检查都通过，你的 CreditPilot 系统已经成功部署并可以正常使用了！

**下一步**：
1. 开始使用系统上传账单
2. 等待每日自动提醒邮件
3. 定期检查系统运行状态

---

**文档版本**：1.0  
**最后更新**：2025-12-10  
**维护者**：CreditPilot 团队


