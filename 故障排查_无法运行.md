# Railway 无法运行 - 故障排查指南

**如果 Railway 无法运行，按照以下步骤排查**

---

## 🔍 第一步：检查部署日志

### 1.1 查看部署日志

1. 进入 **Web 服务** → **Deployments** → 最新部署
2. 点击 **"Logs"** 或 **"View Logs"**
3. 查看完整的部署日志

### 1.2 查找关键信息

**应该看到**：
```
============================================================
CreditPilot 启动中...
============================================================
✅ DATABASE_URL 已设置
============================================================
初始化数据库...
============================================================
📊 数据库连接: postgresql://***@...
🔨 创建数据库表...
✅ 数据库表创建成功
✅ 数据库初始化完成
============================================================
启动API服务器...
============================================================
INFO:     Started server process
INFO:     Uvicorn running on http://0.0.0.0:8000
```

**如果看到错误**：
- ❌ 红色错误信息
- ❌ "数据库初始化失败"
- ❌ "启动失败"
- ❌ "ModuleNotFoundError"
- ❌ "Connection refused"

---

## 🔍 第二步：常见错误及解决方案

### 错误 1：数据库连接失败

**错误信息**：
```
✗ 数据库初始化失败: could not connect to server
✗ 数据库初始化失败: connection refused
✗ 数据库初始化失败: password authentication failed
```

**原因**：
1. `DATABASE_URL` 格式错误
2. Postgres 服务未运行
3. 服务名称不匹配

**解决步骤**：

1. **检查 DATABASE_URL 格式**：
   - 进入 Web 服务 → Variables
   - 查找 `DATABASE_URL`
   - 确认格式：`${{ Postgres.DATABASE_URL }}`
   - ⚠️ 必须是双大括号 `{{ }}`，有空格

2. **检查 Postgres 服务**：
   - 进入 Postgres 服务
   - 确认服务状态是 "Running"（绿色）
   - 如果未运行，等待启动或检查错误

3. **检查服务名称**：
   - 确认 Postgres 服务名称是 `Postgres`
   - 如果不同，修改 `DATABASE_URL` 中的服务名称
   - 例如：如果服务名是 `postgres-db`，则使用 `${{ postgres-db.DATABASE_URL }}`

4. **重新测试**：
   - 在 Web 服务 Shell 中执行：
     ```bash
     cd backend && python3 init_db.py
     ```

---

### 错误 2：端口错误

**错误信息**：
```
Address already in use
Port 8000 is not available
```

**原因**：
- 端口配置不一致
- 端口被占用

**解决步骤**：

1. **检查端口配置**：
   - 进入 Web 服务 → Settings → Networking
   - 确认 Port = `8000`
   - 如果不同，修改为 `8000`

2. **检查代码配置**：
   - 确认代码中使用：`os.getenv("PORT", 8000)`
   - 确认启动脚本使用：`${PORT:-8000}`

3. **重新部署**：
   - 修改配置后，服务会自动重新部署
   - 或手动触发重新部署

---

### 错误 3：模块导入错误

**错误信息**：
```
ModuleNotFoundError: No module named 'xxx'
ImportError: cannot import name 'xxx'
```

**原因**：
- 依赖未安装
- Python 路径问题

**解决步骤**：

1. **检查 requirements.txt**：
   - 确认 `backend/requirements.txt` 包含所有必需依赖
   - 确认版本号正确

2. **检查 Dockerfile**：
   - 确认 Dockerfile 正确安装依赖：
     ```dockerfile
     RUN pip install --no-cache-dir -r backend/requirements.txt
     ```

3. **检查工作目录**：
   - 确认 Dockerfile 中：`WORKDIR /app/backend`
   - 确认启动脚本在正确目录执行

4. **重新部署**：
   - 推送最新代码到 GitHub
   - Railway 会自动重新构建和部署

---

### 错误 4：文件路径错误

**错误信息**：
```
No such file or directory: /app/uploads
Permission denied: /app/reports
```

**原因**：
- Volume 未挂载
- Mount Path 不一致

**解决步骤**：

1. **检查 Volume 是否创建**：
   - 在项目主页，检查是否有 `uploads` 和 `reports` Volume
   - 如果不存在，创建 Volume（项目级别）

2. **检查 Volume 是否挂载**：
   - 进入 Web 服务 → Settings → Volumes
   - 确认 `uploads` 和 `reports` 已挂载
   - 确认 Mount Path 正确：`/app/uploads`, `/app/reports`

3. **检查代码路径**：
   - 确认代码中使用：`/app/uploads`, `/app/reports`
   - 不是相对路径：`./uploads`, `./reports`

4. **重新挂载 Volume**：
   - 如果挂载不正确，取消挂载后重新挂载

---

### 错误 5：启动脚本错误

**错误信息**：
```
/bin/bash: start.sh: Permission denied
start.sh: command not found
```

**原因**：
- 启动脚本不可执行
- 启动脚本路径错误

**解决步骤**：

1. **检查 Dockerfile**：
   - 确认 Dockerfile 中有：
     ```dockerfile
     RUN chmod +x backend/start.sh
     ```

2. **检查文件路径**：
   - 确认 `backend/start.sh` 存在
   - 确认 Dockerfile CMD：`["bash", "start.sh"]`

3. **重新部署**：
   - 推送最新代码
   - Railway 会重新构建

---

### 错误 6：环境变量未设置

**错误信息**：
```
⚠️  警告: DATABASE_URL 环境变量未设置
KeyError: 'SENDER_EMAIL'
```

**原因**：
- 环境变量未设置
- 变量名错误

**解决步骤**：

1. **检查所有环境变量**：
   - 进入 Web 服务 → Variables
   - 确认所有 8 个必需变量都已设置：
     - `DATABASE_URL`
     - `SENDER_EMAIL`
     - `SENDER_PASSWORD`
     - `RECIPIENT_EMAIL`
     - `SMTP_SERVER`
     - `SMTP_PORT`
     - `UPLOAD_DIR`
     - `REPORTS_DIR`

2. **检查变量值**：
   - 确认值正确
   - 确认没有多余空格

3. **重新部署**：
   - 修改变量后，服务会自动重启
   - 或手动触发重新部署

---

## 🔍 第三步：系统诊断

### 3.1 在 Railway Shell 中诊断

进入 Web 服务 → **Shell** 或 **Terminal**

#### 检查环境变量
```bash
echo $DATABASE_URL
echo $PORT
echo $UPLOAD_DIR
echo $REPORTS_DIR
```

**预期**：所有变量都有值

#### 检查文件路径
```bash
ls -la /app/uploads
ls -la /app/reports
```

**预期**：目录存在且可访问

#### 测试数据库连接
```bash
cd backend
python3 init_db.py
```

**预期**：无错误，显示 "✅ 数据库初始化完成"

#### 检查 Python 模块
```bash
cd backend
python3 -c "from models import Base, engine; print('✅ 模块导入成功')"
```

**预期**：无错误

---

### 3.2 检查服务状态

1. **检查所有服务**：
   - Postgres 服务：应该是 "Running"（绿色）
   - Web 服务：应该是 "Running"（绿色）
   - Reminder-Cron 服务：应该是 "Running" 或 "Idle"（绿色）

2. **如果服务未运行**：
   - 查看服务日志
   - 检查配置错误
   - 修复后重新部署

---

## 🔍 第四步：逐步验证

### 验证 1：Postgres 服务
- [ ] Postgres 服务正在运行
- [ ] Variables 中有 `DATABASE_URL`（自动生成）

### 验证 2：Web 服务配置
- [ ] Build → Builder = `Dockerfile`
- [ ] Deploy → Start Command = **留空**
- [ ] Networking → Port = `8000`
- [ ] Variables → `DATABASE_URL` = `${{ Postgres.DATABASE_URL }}`
- [ ] Variables → 所有其他变量已设置
- [ ] Volumes → `uploads` 和 `reports` 已挂载

### 验证 3：代码配置
- [ ] 所有文件存在
- [ ] 路径使用 `/app/uploads` 和 `/app/reports`
- [ ] 端口使用环境变量 `PORT`

### 验证 4：部署测试
- [ ] 部署日志无错误
- [ ] 数据库初始化成功
- [ ] Web 服务启动成功

---

## 🚨 紧急修复步骤

如果系统完全无法运行，按以下步骤修复：

### 步骤 1：检查关键配置
1. `DATABASE_URL` = `${{ Postgres.DATABASE_URL }}`（格式正确）
2. Port = `8000`
3. Volume 已挂载
4. 所有环境变量已设置

### 步骤 2：重新部署
1. 进入 Web 服务 → Deployments
2. 点击 **"Redeploy"**
3. 查看新的部署日志

### 步骤 3：如果仍然失败
1. 记录具体的错误信息
2. 检查所有配置项
3. 参考本文档的解决方案
4. 或提供错误信息，我可以进一步协助

---

## 📞 需要帮助？

如果按照以上步骤仍无法解决：

1. **收集信息**：
   - 部署日志（完整）
   - 错误信息（精确）
   - 配置截图（遮住敏感信息）

2. **检查点**：
   - DATABASE_URL 格式
   - 服务名称
   - 端口配置
   - Volume 挂载
   - 环境变量

3. **提供信息**：
   - 具体的错误信息
   - 在哪一步失败
   - 已尝试的解决方案

---

**故障排查完成时间**：2025-12-10
