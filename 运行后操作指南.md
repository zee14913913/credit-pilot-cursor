# CreditPilot Railway 运行后操作指南

**系统成功部署后，接下来该做什么？**

---

## 🎉 恭喜！系统已成功部署

现在让我们确保一切正常运行，并开始使用系统。

---

## 第一步：验证系统运行状态

### 1.1 检查所有服务状态

在 Railway 项目主页，确认：

- [ ] **Postgres 服务**：状态显示为 "Running" 或 "Active"
- [ ] **Web 服务**：状态显示为 "Running" 或 "Active"
- [ ] **Reminder-Cron 服务**（方案B）：状态显示为 "Running" 或 "Active"

### 1.2 测试 Web 服务

#### 方法 1：访问健康检查端点
1. 获取 Web 服务的公共 URL
   - 在 Web 服务 → **Networking** → **Public Networking**
   - 复制显示的 URL（例如：`https://creditpilot-production.up.railway.app`）

2. 在浏览器访问：
   ```
   https://your-app.railway.app/health
   ```
   **预期结果**：返回 `{"status": "healthy"}`

#### 方法 2：访问 API 文档
访问：
```
https://your-app.railway.app/docs
```
**预期结果**：显示 Swagger UI 文档页面，可以看到所有 API 端点

#### 方法 3：访问根路径
访问：
```
https://your-app.railway.app/
```
**预期结果**：返回 API 信息 JSON

### 1.3 测试数据库连接

1. 进入 **Web 服务** → **Shell** 或 **Terminal**
2. 执行：
   ```bash
   cd backend && python3 init_db.py
   ```
3. **预期结果**：
   - ✅ 显示 "✅ 数据库表创建成功"
   - ✅ 显示 "✅ 数据库初始化完成"
   - ✅ 无错误信息

### 1.4 检查部署日志

查看所有服务的部署日志，确认：

- [ ] **Web 服务日志**：
  - ✅ "✅ DATABASE_URL 已设置"
  - ✅ "✅ 数据库初始化完成"
  - ✅ "INFO: Uvicorn running on http://0.0.0.0:8000"
  - ✅ 无错误信息

- [ ] **Reminder-Cron 服务日志**（如果使用方案B）：
  - ✅ 服务正常启动
  - ✅ 无错误信息

---

## 第二步：配置和使用系统

### 2.1 导入初始数据（可选）

如果你有 CSV 文件需要导入：

1. **准备 CSV 文件**
   - 确保 CSV 文件格式正确
   - 参考 `CSV导入说明.md`

2. **通过 API 导入**
   - 访问：`https://your-app.railway.app/docs`
   - 找到 `POST /api/import/csv` 端点
   - 上传 CSV 文件

3. **或使用 curl 命令**：
   ```bash
   curl -X POST "https://your-app.railway.app/api/import/csv" \
     -H "Content-Type: multipart/form-data" \
     -F "file=@your-file.csv"
   ```

### 2.2 上传账单 PDF

#### 方法 1：通过 API 文档上传
1. 访问：`https://your-app.railway.app/docs`
2. 找到 `POST /api/statements/upload` 端点
3. 上传 Alliance Bank PDF 账单

#### 方法 2：使用 curl 命令
```bash
curl -X POST "https://your-app.railway.app/api/statements/upload" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@statement.pdf"
```

### 2.3 查看 Dashboard 数据

访问：
```
https://your-app.railway.app/api/dashboard/stats
```

**返回信息**：
- 总账单数
- 已验证账单数
- 总余额
- 即将到期的账单数

### 2.4 上传单据

#### 上传 Merchant Receipt
```bash
curl -X POST "https://your-app.railway.app/api/documents/upload" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@receipt.jpg" \
  -F "statement_id=1" \
  -F "document_type=merchant_receipt"
```

#### 上传 Payment Slip
```bash
curl -X POST "https://your-app.railway.app/api/documents/upload" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@payment.pdf" \
  -F "statement_id=1" \
  -F "document_type=payment_slip"
```

#### 上传 Transfer Slip
```bash
curl -X POST "https://your-app.railway.app/api/documents/upload" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@transfer.pdf" \
  -F "statement_id=1" \
  -F "document_type=transfer_slip"
```

---

## 第三步：验证定时任务（Cron）

### 3.1 检查 Cron 服务配置

确认 Reminder-Cron 服务（方案B）：
- [ ] Cron Schedule = `0 14 * * *`（每天 UTC 14:00，马来西亚时间 22:00）
- [ ] Start Command = `cd backend && python3 reminder_system.py`
- [ ] 所有环境变量已设置

### 3.2 手动测试 Cron 任务（可选）

如果想立即测试，可以手动触发：

1. 进入 **Reminder-Cron 服务** → **Deployments**
2. 点击 **"Redeploy"** 或 **"Deploy"**
3. 查看日志，确认：
   - ✅ 执行 `reminder_system.py`
   - ✅ 生成 Excel 报告
   - ✅ 发送邮件
   - ✅ 无错误

### 3.3 验证邮件发送

1. **检查收件箱**：`wang041396@gmail.com`
2. **查找邮件**：
   - 发件人：`business@infinite-gz.com`
   - 主题：包含 "CreditPilot 每日提醒"
   - 附件：Excel 日报文件

3. **如果未收到邮件**：
   - 检查垃圾邮件文件夹
   - 检查 Reminder-Cron 服务日志
   - 确认所有邮件环境变量正确

---

## 第四步：日常使用和维护

### 4.1 日常操作流程

#### 每天的操作：
1. **系统自动执行**（UTC 14:00 / 马来西亚时间 22:00）：
   - ✅ 生成每日提醒 Excel 报告
   - ✅ 发送邮件到 `wang041396@gmail.com`
   - ✅ 记录提醒日志

2. **小助理需要做的**：
   - 📧 查收每日邮件提醒
   - 📊 查看 Excel 报告中的到期账单
   - 📤 上传相关单据（Merchant Receipt、Payment Slip、Transfer Slip）

#### 上传新账单：
- 📄 上传 Alliance Bank PDF 账单
- 🔍 系统自动解析和分类
- ✅ 验证账单信息

### 4.2 监控系统状态

#### 定期检查（建议每周一次）：

1. **检查服务状态**
   - Railway 项目主页 → 确认所有服务正常运行

2. **检查部署日志**
   - Web 服务 → Deployments → 查看最新部署日志
   - Reminder-Cron 服务 → Deployments → 查看最新部署日志

3. **检查数据库**
   - 在 Web 服务 Shell 中：
     ```bash
     cd backend
     python3 -c "from models import SessionLocal, Statement; db = SessionLocal(); print(f'总账单数: {db.query(Statement).count()}')"
     ```

4. **检查邮件发送**
   - 确认每天收到邮件提醒
   - 如果连续几天未收到，检查 Cron 服务日志

### 4.3 查看日志

#### Web 服务日志：
1. 进入 **Web 服务** → **Deployments**
2. 点击最新部署 → **Logs**
3. 查看：
   - API 请求日志
   - 错误信息（如果有）
   - 数据库操作日志

#### Reminder-Cron 服务日志：
1. 进入 **Reminder-Cron 服务** → **Deployments**
2. 点击最新部署 → **Logs**
3. 查看：
   - Cron 任务执行日志
   - Excel 报告生成日志
   - 邮件发送日志

---

## 第五步：常见操作

### 5.1 查看账单列表

访问：
```
https://your-app.railway.app/api/statements
```

或使用 curl：
```bash
curl https://your-app.railway.app/api/statements
```

### 5.2 查看特定账单详情

访问：
```
https://your-app.railway.app/api/statements/{id}
```

例如：
```
https://your-app.railway.app/api/statements/1
```

### 5.3 查看账单的交易记录

访问：
```
https://your-app.railway.app/api/statements/{id}/transactions
```

### 5.4 下载 Excel 日报

访问：
```
https://your-app.railway.app/api/reminders/daily-report
```

这会生成并下载最新的 Excel 日报。

### 5.5 查看上传的文档

访问：
```
https://your-app.railway.app/api/documents
```

### 5.6 下载文档

访问：
```
https://your-app.railway.app/api/documents/{id}/download
```

---

## 第六步：故障处理和问题排查

### 6.1 系统无法访问

**症状**：无法访问 Web 服务 URL

**排查步骤**：
1. 检查 Web 服务状态（Railway 项目主页）
2. 查看部署日志（Web 服务 → Deployments → Logs）
3. 检查端口配置（Networking → Port = 8000）
4. 检查环境变量（特别是 `DATABASE_URL`）

### 6.2 数据库连接失败

**症状**：`init_db.py` 执行失败

**排查步骤**：
1. 检查 `DATABASE_URL` 格式：`${{ Postgres.DATABASE_URL }}`
2. 检查 Postgres 服务是否运行
3. 检查 Postgres 服务名称是否正确
4. 查看 Web 服务日志中的错误信息

### 6.3 邮件未发送

**症状**：未收到每日提醒邮件

**排查步骤**：
1. 检查 Reminder-Cron 服务日志
2. 检查邮件环境变量：
   - `SENDER_EMAIL`
   - `SENDER_PASSWORD`（Gmail 应用密码）
   - `RECIPIENT_EMAIL`
   - `SMTP_SERVER`
   - `SMTP_PORT`
3. 检查垃圾邮件文件夹
4. 确认 Gmail 应用密码是否有效

### 6.4 Cron 任务不执行

**症状**：定时任务不运行

**排查步骤**：
1. 检查 Reminder-Cron 服务状态
2. 检查 Cron Schedule：`0 14 * * *`
3. 检查 Start Command：`cd backend && python3 reminder_system.py`
4. 查看 Reminder-Cron 服务日志
5. 手动触发一次部署测试

### 6.5 文件上传失败

**症状**：无法上传文件

**排查步骤**：
1. 检查 Volume 是否已挂载（`uploads` Volume）
2. 检查 Volume Mount Path：`/app/uploads`
3. 检查文件大小限制
4. 查看 Web 服务日志中的错误信息

---

## 第七步：备份和维护

### 7.1 数据库备份（重要）

Railway 的 PostgreSQL 服务会自动备份，但建议：

1. **定期导出数据**（可选）：
   - 使用 Railway 的数据库管理工具
   - 或通过 API 导出数据

2. **监控数据库使用量**：
   - Railway 项目主页 → Postgres 服务
   - 查看存储使用情况

### 7.2 代码更新

如果需要更新代码：

1. **本地修改代码**
2. **推送到 GitHub**：
   ```bash
   git add .
   git commit -m "更新说明"
   git push origin main
   ```
3. **Railway 自动部署**：
   - Railway 检测到新代码后会自动重新部署
   - 查看部署日志确认成功

### 7.3 环境变量更新

如果需要更新环境变量：

1. 进入相应服务 → **Variables**
2. 编辑或添加变量
3. 保存后，Railway 会自动重新部署

**⚠️ 注意**：更新环境变量后，服务会自动重启。

---

## 第八步：性能优化和监控

### 8.1 监控资源使用

在 Railway 项目主页：
- 查看各服务的 CPU 和内存使用情况
- 如果使用量过高，考虑升级计划

### 8.2 查看 Metrics

进入服务 → **Metrics**：
- 查看请求量
- 查看响应时间
- 查看错误率

### 8.3 优化建议

1. **定期清理旧数据**（如果需要）
2. **监控 Volume 使用量**（`uploads` 和 `reports`）
3. **检查日志文件大小**

---

## 第九步：安全注意事项

### 9.1 保护敏感信息

- ✅ 不要在代码中硬编码密码
- ✅ 使用环境变量存储敏感信息
- ✅ 定期更新 Gmail 应用密码

### 9.2 API 访问控制

当前系统允许所有来源访问（CORS: `allow_origins=["*"]`）。

**生产环境建议**：
- 限制允许的来源域名
- 添加 API 认证（如果需要）

### 9.3 定期检查

- 定期检查 Railway 账户安全
- 定期检查 GitHub 仓库访问权限
- 定期更新依赖包（如果发现安全漏洞）

---

## 第十步：联系和支持

### 10.1 查看文档

- `README.md` - 项目说明
- `USAGE_GUIDE.md` - 使用指南
- `RAILWAY_最终配置指南_官方标准.md` - 配置指南
- `故障排查指南.md` - 故障排查

### 10.2 查看日志

遇到问题时，首先查看：
- Railway 部署日志
- 服务运行日志
- 错误信息

### 10.3 常见问题

参考 `故障排查指南.md` 中的常见问题和解决方案。

---

## ✅ 检查清单

完成以下检查，确保系统正常运行：

### 初始验证
- [ ] Web 服务可以访问
- [ ] 健康检查端点返回正常
- [ ] API 文档可以访问
- [ ] 数据库连接正常
- [ ] 所有服务状态正常

### 功能验证
- [ ] 可以上传账单 PDF
- [ ] 可以上传单据
- [ ] 可以查看 Dashboard 数据
- [ ] 可以查看账单列表
- [ ] 可以下载 Excel 报告

### 定时任务验证
- [ ] Reminder-Cron 服务配置正确
- [ ] Cron Schedule 设置正确
- [ ] 邮件环境变量正确
- [ ] 测试邮件发送成功（手动触发）
- [ ] 等待自动执行验证（UTC 14:00）

### 日常维护
- [ ] 知道如何查看日志
- [ ] 知道如何更新代码
- [ ] 知道如何更新环境变量
- [ ] 知道如何排查问题

---

## 🎯 下一步行动

1. **立即执行**：
   - ✅ 验证所有服务正常运行
   - ✅ 测试基本功能（上传账单、查看数据）
   - ✅ 手动测试 Cron 任务（可选）

2. **今天完成**：
   - ✅ 熟悉 API 文档
   - ✅ 测试上传功能
   - ✅ 确认邮件配置正确

3. **本周完成**：
   - ✅ 等待自动 Cron 任务执行
   - ✅ 验证每日邮件提醒
   - ✅ 熟悉日常操作流程

4. **持续进行**：
   - ✅ 定期检查系统状态
   - ✅ 监控日志和错误
   - ✅ 根据需要更新和维护

---

## 📞 需要帮助？

如果遇到问题：
1. 查看 `故障排查指南.md`
2. 查看 Railway 部署日志
3. 检查环境变量配置
4. 参考相关文档

---

**系统已准备就绪，可以开始使用了！** 🚀

**创建时间**：2025-12-10

