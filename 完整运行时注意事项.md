# CreditPilot 完整运行时注意事项

**系统**：CreditPilot 信用卡账单管理系统  
**部署平台**：Railway  
**更新日期**：2025-12-10

---

## 🔧 运行时配置注意事项

### 1. 环境变量管理

#### 必需的环境变量

**数据库配置**：
- `DATABASE_URL`：必须使用 `${{ Postgres.DATABASE_URL }}` 格式
  - ⚠️ **格式**：双大括号 `{{ }}`，有空格
  - ⚠️ **不要**手动写死连接字符串

**邮件配置**：
- `SENDER_EMAIL`：发件人邮箱（Gmail）
- `SENDER_PASSWORD`：Gmail 应用密码（不是普通密码）
- `RECIPIENT_EMAIL`：收件人邮箱（小助理）
- `SMTP_SERVER`：`smtp.gmail.com`
- `SMTP_PORT`：`587`

**路径配置**：
- `UPLOAD_DIR`：`/app/uploads`（必须与 Volume Mount Path 一致）
- `REPORTS_DIR`：`/app/reports`（必须与 Volume Mount Path 一致）

#### 环境变量检查清单

**Web 服务**：
- [ ] `DATABASE_URL=${{ Postgres.DATABASE_URL }}`
- [ ] 所有邮件变量已设置
- [ ] 所有路径变量已设置

**Reminder-Cron 服务**：
- [ ] `DATABASE_URL=${{ Postgres.DATABASE_URL }}`
- [ ] 所有邮件变量已设置（与 Web 服务相同）
- [ ] 所有路径变量已设置

---

### 2. Volume 管理

#### Volume 配置要求

**必需 Volume**：
1. `uploads` → `/app/uploads`
   - 用于存储上传的 PDF 账单和单据
   - 必须挂载到 Web 服务

2. `reports` → `/app/reports`
   - 用于存储生成的 Excel 报告
   - 必须挂载到 Web 服务和 Reminder-Cron 服务

#### Volume 注意事项

- ⚠️ **路径一致性**：代码中的路径必须与 Volume Mount Path 完全一致
- ⚠️ **持久化存储**：Volume 中的数据在服务重启后仍然保留
- ⚠️ **容量限制**：注意 Railway 免费计划的存储限制
- ⚠️ **备份**：定期备份 Volume 中的重要数据

---

### 3. 数据库管理

#### PostgreSQL 连接

**连接字符串格式**：
- Railway 自动生成 `DATABASE_URL`
- 代码会自动处理 `postgres://` 到 `postgresql://` 的转换
- 连接池配置已优化（`pool_pre_ping=True`, `pool_recycle=300`）

#### 数据库维护

**定期检查**：
- [ ] 数据库连接是否正常
- [ ] 表结构是否正确
- [ ] 数据是否完整

**备份建议**：
- 定期导出数据库备份
- 使用 Railway 的数据库备份功能
- 或使用 `pg_dump` 手动备份

---

### 4. Cron 任务管理

#### 定时任务配置

**Reminder-Cron 服务**：
- **Cron Schedule**：`0 14 * * *`（每天 UTC 14:00，马来西亚时间 22:00）
- **Start Command**：`cd backend && python3 reminder_system.py`

#### Cron 任务注意事项

- ⚠️ **时区**：Cron 使用 UTC 时间，确保时区转换正确
- ⚠️ **执行时间**：每天 22:00（马来西亚时间）执行
- ⚠️ **日志检查**：定期查看 Reminder-Cron 服务日志
- ⚠️ **邮件发送**：确认邮件是否成功发送

#### 手动触发测试

如果需要立即测试 Cron 任务：
1. 进入 Reminder-Cron 服务
2. 点击 "Redeploy" 手动触发
3. 查看日志确认执行结果

---

### 5. API 端点管理

#### CORS 配置

**当前配置**：
```python
allow_origins=["*"]  # 允许所有来源
```

**生产环境建议**：
- ⚠️ 限制为具体的前端域名
- 例如：`allow_origins=["https://your-frontend.com"]`

#### API 端点列表

**Dashboard**：
- `GET /api/dashboard/stats` - 统计数据
- `GET /api/dashboard/upcoming` - 即将到期账单

**账单管理**：
- `POST /api/statements/upload` - 上传 PDF 账单
- `GET /api/statements` - 获取所有账单
- `GET /api/statements/{id}` - 获取单个账单

**单据管理**：
- `POST /api/documents/upload` - 上传单据
- `GET /api/documents` - 获取所有单据
- `GET /api/documents/{id}/download` - 下载单据

**提醒系统**：
- `GET /api/reminders/test` - 测试提醒
- `GET /api/reminders/daily-report` - 下载 Excel 报告

**数据导入**：
- `POST /api/import/csv` - 导入 CSV 数据

---

### 6. 文件上传管理

#### 上传限制

**PDF 账单**：
- 支持 Alliance Bank 格式
- 文件大小限制（根据 Railway 配置）

**单据文件**：
- 支持图片（JPG, PNG）和 PDF
- 4 种类型：Statement, Merchant Slip, Payment Receipt, Transfer Slip

#### 存储位置

- **上传文件**：`/app/uploads`（Volume）
- **报告文件**：`/app/reports`（Volume）

---

### 7. 邮件发送管理

#### 邮件配置检查

**Gmail 应用密码**：
- ⚠️ 必须使用 Gmail 应用密码，不是普通密码
- ⚠️ 应用密码格式：16 位字符（如：`grqcgnrwqhbeocox`）

**SMTP 配置**：
- `SMTP_SERVER`：`smtp.gmail.com`
- `SMTP_PORT`：`587`（TLS）
- 确保 Gmail 账户已启用"允许不够安全的应用"

#### 邮件发送监控

**检查邮件是否发送**：
1. 查看 Reminder-Cron 服务日志
2. 检查收件箱（wang041396@gmail.com）
3. 检查垃圾邮件文件夹

**常见问题**：
- 邮件进入垃圾邮件：检查发件人设置
- 发送失败：检查应用密码是否正确
- SMTP 错误：检查网络连接和防火墙

---

### 8. 日志管理

#### 日志位置

**Railway 日志**：
- Web 服务 → Deployments → 最新部署 → Logs
- Reminder-Cron 服务 → Deployments → 最新部署 → Logs

#### 日志级别

**重要日志**：
- 数据库初始化成功/失败
- API 请求错误
- Cron 任务执行结果
- 邮件发送状态

#### 日志检查建议

**每日检查**：
- [ ] Web 服务是否正常运行
- [ ] 数据库连接是否正常
- [ ] Cron 任务是否成功执行
- [ ] 邮件是否成功发送

---

### 9. 性能优化

#### 数据库优化

- 使用连接池（已配置）
- 定期清理旧数据
- 添加必要的索引

#### API 优化

- 使用缓存（如需要）
- 优化查询性能
- 限制文件上传大小

---

### 10. 安全注意事项

#### 环境变量安全

- ⚠️ **不要**在代码中硬编码敏感信息
- ⚠️ **不要**在日志中输出密码
- ⚠️ **使用** Railway 的 Variables 管理敏感信息

#### API 安全

- ⚠️ 生产环境限制 CORS 来源
- ⚠️ 考虑添加 API 认证（如需要）
- ⚠️ 限制文件上传类型和大小

#### 数据库安全

- ⚠️ 使用强密码
- ⚠️ 定期备份数据库
- ⚠️ 限制数据库访问权限

---

### 11. 监控和维护

#### 日常监控

**每日检查**：
- [ ] 系统是否正常运行
- [ ] Cron 任务是否执行
- [ ] 邮件是否发送
- [ ] 数据库连接是否正常

**每周检查**：
- [ ] 查看错误日志
- [ ] 检查存储使用情况
- [ ] 验证数据完整性

**每月检查**：
- [ ] 数据库备份
- [ ] 性能优化
- [ ] 安全审计

---

### 12. 故障处理

#### 常见问题

**数据库连接失败**：
1. 检查 `DATABASE_URL` 格式
2. 检查 Postgres 服务状态
3. 查看错误日志

**Cron 任务不执行**：
1. 检查 Cron Schedule 格式
2. 检查 Start Command
3. 查看 Reminder-Cron 服务日志

**邮件发送失败**：
1. 检查 Gmail 应用密码
2. 检查 SMTP 配置
3. 查看错误日志

**文件上传失败**：
1. 检查 Volume 是否挂载
2. 检查路径是否正确
3. 检查文件权限

---

## 📋 运行时检查清单

### 每日检查
- [ ] Web 服务正常运行
- [ ] 数据库连接正常
- [ ] Cron 任务执行成功
- [ ] 邮件发送成功

### 每周检查
- [ ] 查看错误日志
- [ ] 检查存储使用
- [ ] 验证数据完整性

### 每月检查
- [ ] 数据库备份
- [ ] 性能优化
- [ ] 安全审计

---

## ✅ 总结

**关键注意事项**：
1. ✅ 环境变量格式正确（特别是 `DATABASE_URL`）
2. ✅ Volume 路径一致
3. ✅ Cron 任务配置正确
4. ✅ 邮件配置正确
5. ✅ 定期监控和维护

**如果遇到问题**：
1. 查看日志
2. 检查配置
3. 参考故障排查指南
4. 联系技术支持

---

**文档版本**：1.0  
**最后更新**：2025-12-10


